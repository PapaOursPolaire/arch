set -e

echo "ğŸš€ Lancement de l'installation complÃ¨te Arch Linux + Hyprland + GRUB personnalisÃ©"

# ğŸ“¥ Demande d'infos
read -p "ğŸ’¾ Partition EFI (ex: /dev/sda1) : " EFI_PART
read -p "ğŸ“ Partition ROOT (ex: /dev/sda2) : " ROOT_PART
read -p "ğŸ‘¤ Nom d'utilisateur : " USERNAME
read -p "ğŸ–¥ï¸ Nom de la machine (hostname) : " HOSTNAME

while true; do
  read -s -p "ğŸ” Mot de passe utilisateur : " USER_PASSWORD
  echo
  read -s -p "ğŸ” Confirmez le mot de passe : " USER_PASSWORD_CONFIRM
  echo
  [ "$USER_PASSWORD" = "$USER_PASSWORD_CONFIRM" ] && break
  echo "âŒ Les mots de passe ne correspondent pas."
done

# âš ï¸ Formatage
echo "ğŸ§¹ Formatage des partitions..."
mkfs.fat -F32 "$EFI_PART"
mkfs.ext4 -F "$ROOT_PART"

# ğŸ“‚ Montage
mount "$ROOT_PART" /mnt
mkdir -p /mnt/boot/efi
mount "$EFI_PART" /mnt/boot/efi

# ğŸ“¦ Installation de base
pacstrap /mnt base base-devel linux linux-firmware grub efibootmgr networkmanager sudo git vim pipewire pipewire-audio pipewire-pulse pipewire-alsa wireplumber

# ğŸ“„ fstab
genfstab -U /mnt >> /mnt/etc/fstab

# ğŸ’¬ Configuration dans chroot
arch-chroot /mnt /bin/bash <<EOF
set -e

echo "ğŸ¯ Configuration dans le systÃ¨me installÃ©"

# ğŸ• Heure et locale
ln -sf /usr/share/zoneinfo/Europe/Brussels /etc/localtime
hwclock --systohc
sed -i 's/#fr_BE.UTF-8 UTF-8/fr_BE.UTF-8 UTF-8/' /etc/locale.gen
locale-gen
echo "LANG=fr_BE.UTF-8" > /etc/locale.conf
echo "KEYMAP=fr" > /etc/vconsole.conf

# ğŸ”  Hostname
echo "$HOSTNAME" > /etc/hostname

# ğŸ‘¤ Utilisateur
useradd -m -G wheel -s /bin/bash "$USERNAME"
echo "$USERNAME:$USER_PASSWORD" | chpasswd
echo "root:$USER_PASSWORD" | chpasswd
echo "%wheel ALL=(ALL:ALL) ALL" >> /etc/sudoers

# ğŸ§  GRUB
grub-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=GRUB
mkdir -p /boot/grub/themes

# ğŸ¨ ThÃ¨mes GRUB
cd /tmp
git clone https://github.com/shvchk/fallout-grub-theme
cp -r fallout-grub-theme /boot/grub/themes/Fallout
echo 'GRUB_THEME="/boot/grub/themes/Fallout/theme.txt"' >> /etc/default/grub
grub-mkconfig -o /boot/grub/grub.cfg

# ğŸ“¡ RÃ©seau
systemctl enable NetworkManager

# ğŸ–¥ï¸ Environnement graphique
pacman -S --noconfirm hyprland kitty waybar wofi rofi nwg-look brightnessctl \
  pavucontrol thunar thunar-archive-plugin neofetch mpv xdg-desktop-portal-hyprland \
  ffmpeg playerctl cava picom

# âš¡ Fastfetch
git clone https://github.com/fastfetch-cli/fastfetch.git /opt/fastfetch
cd /opt/fastfetch
cmake -B build -DCMAKE_BUILD_TYPE=Release
cmake --build build --target fastfetch
cp build/fastfetch /usr/local/bin/

mkdir -p /home/$USERNAME/.config/fastfetch
echo '{ "logo": "arch", "color": "magenta" }' > /home/$USERNAME/.config/fastfetch/config.jsonc
chown -R $USERNAME:$USERNAME /home/$USERNAME/.config

# ğŸŒ«ï¸ Picom
mkdir -p /home/$USERNAME/.config/picom
echo 'opacity-rule = [ "90:class_g = '\''kitty'\''" ]; backend = "glx"; vsync = true; blur-method = "dual_kawase"; blur-strength = 5;' > /home/$USERNAME/.config/picom/picom.conf
chown -R $USERNAME:$USERNAME /home/$USERNAME/.config/picom

# ğŸ”Š Cava
mkdir -p /home/$USERNAME/.config/cava
cp /etc/cava/config /home/$USERNAME/.config/cava/config
chown -R $USERNAME:$USERNAME /home/$USERNAME/.config/cava

# ğŸï¸ Fond vidÃ©o
mkdir -p /usr/share/wallpapers
curl -Lo /usr/share/wallpapers/arcane-background.mp4 https://example.com/arcane.mp4 || true
cat <<EOL > /etc/systemd/system/video-wallpaper.service
[Unit]
Description=Video Wallpaper
After=graphical.target

[Service]
ExecStart=/usr/bin/mpv --loop --no-audio --wid=\$(xdotool search --onlyvisible --class Hyprland | head -n1) /usr/share/wallpapers/arcane-background.mp4

[Install]
WantedBy=default.target
EOL

systemctl enable video-wallpaper.service

echo "âœ… Configuration terminÃ©e."
EOF

echo "ğŸ‰ Installation complÃ¨te ! Tu peux maintenant redÃ©marrer dans ton Arch Linux personnalisÃ© ğŸŒŒ"
